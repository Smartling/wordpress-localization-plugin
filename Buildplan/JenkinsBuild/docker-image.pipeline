pipeline {
  agent any

  environment {
    full_image_name = "011954687103.dkr.ecr.us-east-1.amazonaws.com/wordpress-connector-build"
  }

  stages {
    stage('Build Docker image') {
      steps {
        sh "docker build --no-cache --rm --pull --tag=${full_image_name} -f \"./../Docker/Dockerfile\" ."
      }
    }

    stage('Push docker images') {
      steps {
        sh 'eval $(aws ecr get-login --region us-east-1)'
        sh "docker push ${full_image_name}"
      }
    }

    stage('Post build clean up') {
      steps {
        sh "docker rmi ${full_image_name}"
      }
    }
  }

  post {
    failure {
      slackSend (
        channel: "${params.SLACK_CHAT}",
        color: 'bad',
        message: "Build of <${env.BUILD_URL}|${env.JOB_BASE_NAME} #${env.BUILD_NUMBER}> is failed!"
      )
    }
  }
}
